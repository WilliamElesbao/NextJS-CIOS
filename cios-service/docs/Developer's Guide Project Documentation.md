# Project Documentation for cios-service

- [Introduction](#introduction)
- [Folder Structure](#folder-structure)
- [Prisma Schemas](#prisma-schemas)
- [Prisma Service](#prisma-service)
- [Application Services](#application-services)
- [Modules](#modules)
- [Type Definitions](#type-definitions)
- [Environment Variables](#environment-variables)

## Introduction

The cios-service project is a NestJS application designed to manage and synchronize worker data between different systems using Prisma as the ORM for interacting with SQL Server databases.

## Folder Structure

    src
        ├── app.module.ts
        ├── application
        │   └── services
        │       ├── cios
        │       │   └── workers.service.ts
        │       ├── job
        │       │   └── job.service.ts
        │       ├── portal
        │       │   └── users_portal.service.ts
        │       └── tm_se_suite
        │           └── users_se_suite.service.ts
        ├── infra
        │   ├── data
        │   │   ├── client
        │   │   │   └── prisma.service.ts
        │   │   └── prisma
        │   │       ├── cios.prisma
        │   │       ├── sql003.prisma
        │   │       └── sql003_portal.prisma
        │   └── modules
        │       ├── cios
        │       │   └── cios.module.ts
        │       ├── db
        │       │   └── prisma.module.ts
        │       ├── job
        │       │   └── job.module.ts
        │       ├── portal
        │       │   └── portal.module.ts
        │       └── tm_se_suite
        │           └── tm_se_suite.module.ts
        ├── lib
        │   └── definitions.ts
        └── main.ts

## Prisma Schemas

`cios.prisma`
`sql003_portal.prisma`
`sql003.prisma`

These schemas are generated by inspecting the database each of the schemas connects to. The command `npx prisma --schema <path to the .prisma file> db pull` is used to pull the tables and relationships from the selected database. In this case, we use only the `Usuarios` table from the `PORTAL` database, the `seUsers` and `seDepartment` tables from the `TMSESUITE` database, and also the `Worker` table from the `TM-CIOS` application.

## Prisma Service

`src/infra/data/client/prisma.service.ts`

The `PrismaService` is a crucial part of the cios-service application, responsible for managing the database connections and operations. This service integrates multiple Prisma clients to interact with different databases, ensuring efficient and organized data management.

###### Key Responsibilities:

1. Initialization and Connection Management:

   - The PrismaService implements the OnModuleInit interface, which ensures that the database connections are established when the module is initialized.
   - It connects to three different databases: `cios`, `TMSESUITE`, and `PORTAL`. Each database is represented by its own Prisma client:
     - `PrismaCIOS` for the `cios` database.
     - `PrismaTMSESUITE` for the `TMSESUITE` database.
     - `PrismaPORTAL` for the `PORTAL` database.

2. Multiple Database Integration:

   - By having separate Prisma clients for each database, the PrismaService allows the application to manage and synchronize data across multiple systems efficiently.
   - This is particularly useful for applications that need to interact with different data sources, each with its own schema and structure.

3. Lifecycle Management:

   - The PrismaService handles the lifecycle of the database connections, ensuring that they are properly established when the application starts (onModuleInit) and gracefully closed when the application shuts down (onModuleDestroy).

4. Centralized Database Operations:

   - Centralizing the database operations in a single service promotes better organization and maintainability. It provides a clear and consistent way to manage database interactions, reducing the complexity of handling multiple data sources within the application.

## Application Services

- [x] <b>Worker Service (`cios`)</b> - The worker service has some methods that perform queries and mutations on the worker table of the cios application
  ###### Queries:
  - [x] findWorkers
  - [x] findWorkersWithoutEmail
  ###### Mutations:
  - [x] createWorker
  - [x] updateWorker
- [x] <b>Job Service (`job`)</b> - The `JobService` is responsible for running scheduled tasks (cron jobs) to synchronize worker data between different systems. It uses NestJS's scheduling capabilities and interacts with three services: `WorkerService`, `UserPortalService`, and `UserSeSuiteService`.

  ###### Key Responsibilities:

  - <b>Scheduled Tasks (Cron Jobs):</b>

    - The handleCron method runs every minute, as specified by the CronExpression.EVERY_MINUTE schedule.
    - When the cron job starts, it logs a debug message and calls the syncWorkers method to synchronize the worker data.

  - <b>Worker Synchronization:</b>

    - The syncWorkers method fetches workers from the cios service and users from the TMSESUITE and PORTAL services.
    - It creates a map of user emails from the PORTAL service based on their registration number (matricula).
    - It then iterates through the users from the TMSESUITE service, looking for matching workers in the cios service by comparing their registration numbers.
    - For each matching worker, it checks if there are any changes in their details (e.g., name, email, department, manager, status). If changes are found and the email is valid, it updates the worker's information in the cios service.
    - If no matching worker is found, it creates a new worker in the cios service.
    - Logs are generated for each worker update or creation to keep track of the operations performed.

  - <b>Logging:</b>

    - The JobService logs messages at various stages to provide visibility into the synchronization process. This includes starting the cron job, synchronizing workers, updating workers, creating new workers, and completing the synchronization.

- [x] <b>User Portal Service (`portal`)</b> - The UserPortalService is responsible for interacting with the PORTAL database to fetch user data. It uses the PrismaService to access the sql003PortalClient and perform queries on the usuarios table.

  ###### Key Responsibilities:

  - Fetch Portal Users:
    - The findPortalUsers method retrieves users from the usuarios table in the PORTAL database.
  - It filters users based on several conditions:
    - Email should not be empty or null.
    - CPF should not be null.
    - The user's status (situacaosenior) should not be 7-Demitido (indicating the user is not dismissed).

- [x] <b>User SE Suite Service (tm_se_suite)</b> - The UserSeSuiteService is responsible for interacting with the TMSESUITE database to fetch user data. It uses the PrismaService to access the sql003TmSESuiteClient and perform queries on the seUsers table.
  ###### Key Responsibilities:
  - Fetch SE Suite Users:
    - The findSeSuiteUsers method retrieves users from the seUsers table in the TMSESUITE database.
    - It filters users to include only those with an active status (situacao set to Ativo).

## Modules

Worker Module (cios)
Job Module (job)
Prisma Module (db)
User Portal Module (portal)
User SE Suite Module (tm_se_suite)

<b>Module Integration Overview</b>
In the cios-service project, different modules are created to organize and manage specific functionalities. Each module imports and utilizes the respective services to maintain a clean and modular structure. This helps in managing dependencies and enhances the scalability and maintainability of the project.

<b>Worker Module (cios)</b>
The WorkerModule handles all operations related to workers within the cios application. It imports the WorkerService to interact with the workers table in the cios database.

<b>Job Module (job)</b>
The JobModule is responsible for scheduling and running background tasks. It imports the JobService which, in turn, utilizes the WorkerService, UserPortalService, and UserSeSuiteService to synchronize worker data across different systems.

<b>Prisma Module (db)</b>
The PrismaModule encapsulates the configuration and initialization of the Prisma clients. It imports the PrismaService, which provides methods to connect and disconnect from the various databases (cios, TMSESUITE, and PORTAL).

<b>User Portal Module (portal)</b>
The UserPortalModule manages user-related operations for the PORTAL database. It imports the UserPortalService to fetch user data from the usuarios table.

<b>User SE Suite Module (tm_se_suite)</b>
The UserSeSuiteModule handles user-related operations for the TMSESUITE database. It imports the UserSeSuiteService to fetch user data from the seUsers table.

## Type Definitions

define the shape and structure of objects, providing type safety and ensuring that data conforms to the expected format. In the context of the cios-service project, type definitions are used to represent the data models for users from different systems (SE Suite, Portal, and CIOS) and a mapping of users. This helps in maintaining consistency and avoiding errors when working with these data structures.

<b>SE Suite Users</b>
The SeUsers type defines the structure of user data from the SE Suite system. This type includes various fields that represent user attributes such as matricula (registration number), name, email, area description, and more.

<b>Portal Users</b>
The PortalUsers type defines the structure of user data from the Portal system. This type includes fields such as user ID, company ID, name, cost center, registration number, login, status, email, CPF, and branch name.

<b>CIOS Workers</b>
The CiosWorkers type defines the structure of worker data within the CIOS application. This type includes fields such as worker ID, registration number, name, email, cost center, supervisor, manager, status, and timestamps for creation and updates.

<b>Users Map</b>
The UsersMap type defines a mapping of user registration numbers to their emails. This is particularly useful for quickly looking up email addresses based on the registration number.

## Environment Variables

`.env`

    # port
    PORT=

    # database config
    DATABASE_URL_003_TMSESUITE=

    DATABASE_URL_003_PORTAL=

    DATABASE_URL_TMCIOS=
